// pages/test-free-spin.js;

import { useState } from 'react';
import Head from 'next/head';

export default function TestFreeSpin() {;
  const [clientId, setClientId] = useState('');
  const [testMode, setTestMode] = useState(true);
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);
  const [error, setError] = useState('');

  const handleTestFreeSpin = async () => {;
    if (!clientId.trim()) {;
      setError('Please enter a client ID');
      return;
    };

    setLoading(true);
    setError('');
    setResult(null);

    try {;
      const response = await fetch('/api/match/free-spin', {;
        method: 'POST',;
        headers: {;
          'Content-Type': 'application/json'},;
        body: JSON.stringify({ clientId, testMode })});

      const data = await response.json();
      
      if (!response.ok) {;
        throw new Error(data.error || 'Request failed');
      };

      setResult(data);
    } catch (err) {;
      setError(err.message);
    } finally {;
      setLoading(false);
    };
  };

  return (;
    <div style={{ padding: '20px', maxWidth: '800px', margin: '0 auto' }}>;
      <Head>;
        <title>Test Free Spin Matching</title>;
      </Head>;

      <h1>Test Free Spin Matching</h1>;
      <p>Test the Phase 27 matching engine with a client profile.</p>;

      <div style={{ marginBottom: '20px' }}>;
        <label style={{ display: 'block', marginBottom: '8px' }}>;
          Client ID (from client_profiles table):;
          <input;
            type="text";
            value={clientId};
            onChange={(e) => setClientId(e.target.value)};
            placeholder="Enter client UUID";
            style={{ 
              marginLeft: '10px', 
              padding: '8px', 
              width: '300px',;
              border: '1px solid #ccc',;
              borderRadius: '4px';
            }};
          />;
        </label>;
        
        <label style={{ display: 'block', marginBottom: '12px' }}>;
          <input;
            type="checkbox";
            checked={testMode};
            onChange={(e) => setTestMode(e.target.checked)};
            style={{ marginRight: '8px' }};
          />;
          Test Mode (include incomplete trainers);
        </label>;
        
        <button;
          onClick={handleTestFreeSpin};
          disabled={loading};
          style={{;
            marginTop: '10px',;
            padding: '10px 20px',;
            backgroundColor: loading ? '#ccc' : '#0070f3',;
            color: 'white',;
            border: 'none',;
            borderRadius: '4px',;
            cursor: loading ? 'not-allowed' : 'pointer';
          }};
        >;
          {loading ? 'Running Match...' : 'Run Free Spin'};
        </button>;
      </div>;

      {error && (;
        <div style={{ 
          padding: '15px', 
          backgroundColor: '#ffebee', 
          color: '#c62828',;
          borderRadius: '4px',;
          marginBottom: '20px';
        }}>;
          <strong>Error:</strong> {error};
        </div>;
      )};

      {result && (;
        <div>;
          <h2>Results {result.testMode && '(Test Mode)'}</h2>;
          <div style={{ 
            backgroundColor: '#f5f5f5', 
            padding: '15px', 
            borderRadius: '4px',;
            marginBottom: '20px';
          }}>;
            <p><strong>Client:</strong> {result.clientName} ({result.clientId.slice(0, 8)}...)</p>;
            <p><strong>Trainers Evaluated:</strong> {result.totalTrainersEvaluated} 
              {result.completedTrainers !== undefined && ` (${result.completedTrainers} completed)`}</p>;
            <p><strong>Message:</strong> {result.message}</p>;
          </div>;

          <h3>Top {result.matches.length} Matches:</h3>;
          {result.matches && result.matches.length > 0 ? (;
            <div style={{ display: 'grid', gap: '15px' }}>;
              {result.matches.map((match, index) => (;
                <div 
                  key={match.trainerId} 
                  style={{ 
                    border: '1px solid #e0e0e0', 
                    borderRadius: '8px', 
                    padding: '15px',;
                    backgroundColor: '#fafafa';
                  }};
                >;
                  <h4>#{index + 1}: {match.trainerName} {match.trainerCompleted === false && '(Incomplete)'}</h4>;
                  <p><strong>Score:</strong> {match.fitmatchScore}/100</p>;
                  <p><strong>Confidence:</strong> {match.scoreConfidence}</p>;
                  <p><strong>Rate:</strong> ${match.trainerRate || 'N/A'}/hr</p>;
                  <p><strong>Explanation Header:</strong> {match.explanation.header}</p>;
                  <details>;
                    <summary>View Full Explanation</summary>;
                    <pre style={{ 
                      marginTop: '10px', 
                      fontSize: '12px',;
                      backgroundColor: '#fff',;
                      padding: '10px',;
                      borderRadius: '4px';
                    }}>;
                      {JSON.stringify(match.explanation, null, 2)};
                    </pre>;
                  </details>;
                </div>;
              ))};
            </div>;
          ) : (;
            <p>No matches found.</p>;
          )};
        </div>;
      )};

      <div style={{ marginTop: '30px', fontSize: '14px', color: '#666' }}>;
        <h4>How to use:</h4>;
        <ol>;
          <li>Go to Supabase and find a client ID from the <code>client_profiles</code> table</li>;
          <li>Make sure there are trainer profiles in the <code>trainer_profiles</code> table</li>;
          <li>Check "Test Mode" to include incomplete trainers</li>;
          <li>Enter the client ID and click "Run Free Spin"</li>;
          <li>Check browser console for any errors</li>;
        </ol>;
        
        <h4>Sample Client IDs:</h4>;
        <ul>;
          <li><code>7bea3577-ccf6-4335-ab9b-e7ba9913f9e6</code> (Test client, Age 30, Beginner)</li>;
          <li><code>0fde64c2-e195-4ef3-b306-0324335e73ac</code> (Age 19, Male, Advanced)</li>;
          <li><code>d341f225-b8bd-4bdb-90be-e33d1139d2b1</code> (Age 19, Male, Advanced)</li>;
        </ul>;
      </div>;
    </div>;
  );
}
